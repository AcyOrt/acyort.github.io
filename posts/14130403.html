<!doctype html>
<html>

<head>
  <meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="keywords" content="acyort, nodejs, blog" />
<meta name="description" content="A Node.js blog tool powered by GitHub." />
<link rel="icon" href="//icon.png" />
<link rel="stylesheet" href="/css/style.css" />

  <title>
就近原则浅探 - AcyOrt
</title>
</head>

<body>

<div class="main">

<div class="header">
    <div class="center">
        <a class="logo" href="/">AcyOrt</a>

        <div class="menu">
            <div class="menuicon"></div>

            <div class="menuitem">
            
            <a href="/">home</a>
            
            <a href="/">about</a>
            
            <a href="/">archives</a>
            
            </div>
        </div>
    </div>
</div>




<div id="post" class="center">

    <p class="time">May 09, 2013</p> 

    <h1 class="title">就近原则浅探</h1>

    <div class="content"><p><img src="https://f.cloud.github.com/assets/97227/481073/869baa3a-b848-11e2-97c1-cd0697b0fa05.jpg" alt="6afd7d1b0d410102fc1bd81635963e62"></p>
<p>这篇文章来自我同事闲耘的投稿。闲耘在前端监控、代码质量等方面颇有研究。下面是全文，欢迎探讨。</p>
<hr>
<h2 id="引子">引子</h2><p>上周有位同事在周报里分享了段 for 循环的「好代码」：</p>
<pre><code class="lang-js"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, item; item = <span class="hljs-keyword">list</span>[i]; i++) {
    <span class="hljs-comment">// 将 ltem = list[i] 当做条件判断语句</span>
    <span class="hljs-comment">// 当 i 下标溢出时，返回 undefined，循环结束</span>
    <span class="hljs-comment">// 居然省了一个变量呢～</span>
}
</code></pre>
<p>这位同事是看了 jQuery 里类似下面这种用法之后做的这个分享：</p>
<pre><code class="lang-js">// If no nodeType, this is expected to be an<span class="hljs-built_in"> array
</span>for ( ; (node = elem[i]); i++ ) {
    // Do<span class="hljs-built_in"> not </span>traverse comment nodes
    ret += getText( node );
}
</code></pre>
<p>jQuery 还有不少地方使用这种用法，也有不少地方是使用传统的 length 来循环。</p>
<p>jQuery 这样用有其特定场景，需要正视。我回复说：</p>
<ol>
<li>如果数组项中有 0, false, null, undefined, &quot;&quot;，代码就出 bug 了。</li>
<li>好像没看到少了变量，一定要少的话，典型的 for 写法也可以少（但是不推荐）。</li>
<li>代码是写给人读的，顺便给机器执行。</li>
<li>另外，对 list 本身有操作，尤其是长度有影响的操作要特别注意。</li>
</ol>
<p>我个人推荐下面这种写法：</p>
<pre><code class="lang-js"><span class="hljs-keyword">for</span>(var <span class="hljs-built_in">i</span> = <span class="hljs-number">0</span>, l = list.<span class="hljs-built_in">length</span>; <span class="hljs-built_in">i</span> &lt; l; <span class="hljs-built_in">i</span>++) {
    // ...
}
</code></pre>
<p>小提示：使用 Vim snipMate 的同学可以参考 <a href="https://github.com/hotoo/snipmate.vim/blob/master/snippets/javascript.snippets#L56">javascript.snippet</a> 这个代码片段模板。</p>
<p>好了，使用溢出判断数组循环结束的讨论到此就结束了，但是好戏还在后头。</p>
<p>由于 JavaScript 作用域的问题，有同学建议说将 <code>i</code>, <code>l</code> 变量定义在 <code>for</code> 循环之外。于是进入另一个话题。</p>
<h2 id="如何定义块级作用域中使用的变量？">如何定义块级作用域中使用的变量？</h2><p>持有变量应前置定义观点的同学，估计有不少是受了《JavaScript 权威指南》或其他权威著作的影响。</p>
<p>《JavaScript 权威指南》第 4 章 4.3.1 小节详细分析了块级作用域中变量定义的问题。</p>
<p>由于 JavaScript 只有函数作用域，没有块级作用域，因此在 <code>for</code>、<code>if/else</code>、<code>do/while</code>、<code>switch/case</code>、<code>try/catch</code> 这些块中定义的变量，实际在块之外也可以使用。</p>
<pre><code class="lang-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">functionScope</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = <span class="hljs-number">5</span>; i &lt; l; i++) {
    <span class="hljs-keyword">var</span> blockVariable = i;
  }
  alert(i); <span class="hljs-comment">// 5</span>
  alert(blockVariable); <span class="hljs-comment">// 4</span>
}
</code></pre>
<p>上面的代码，在 for 这个块之中定义的变量，在 for 之外也可以使用。这在其他支持块级作用域（如C / C++ / Java）的编程语言中是无法理解，甚至不可接受的。</p>
<p>这是 JavaScript 设计的 bug，书中作者建议将所有变量声明集中放置在函数开头，说这是个好习惯。</p>
<blockquote>
<p>This example illustrates why it is good programming practice to place all of your variable declarations together at the start of any function.</p>
</blockquote>
<p>JavaScript 传教士老道也有<a href="http://javascript.crockford.com/code.html#variable declarations">类似的教诲</a>：</p>
<blockquote>
<p>The var statements should be the first statements in the function body.</p>
<p>...</p>
<p>JavaScript does not have block scope, so defining variables in blocks can confuse programmers who are experienced with other C family languages. Define all variables at the top of the function.</p>
</blockquote>
<p>他们的理由是，既然在块级作用域之内定义的变量可以被块级作用域之外使用，那么就应该把变量定义在块级作用域之外，让它们看起来和它们实际的作用域表现一致。</p>
<pre><code class="lang-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">functionScope</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> i, l = <span class="hljs-number">5</span>, blockVariable;

  <span class="hljs-comment">// more codes ...</span>

  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; l; i++) {
    blockVariable = i;
  }
}
</code></pre>
<p>但是这个我稍微持不同的观点 ：）</p>
<p>实际上我们定义 <code>i</code>, <code>l</code> 是为了给 <code>for</code> 用的，JavaScript 解释器在执行的时候可以给块级作用域外面用，不代表就应该定义在外面。</p>
<p>定义在外面给人的暗示是这个变量是给整个 function 用的，而不只是 for 循环，就会给人「在外面用也没关系」的错觉。但这其实不是我们定义 <code>i</code>, <code>l</code> 的本意。</p>
<p>另外变量前置声明，会导致变量声明、定义和使用之间分离，变量含义自我解释性被削弱，而且容易造成误清理、或遗漏清理变量的问题。</p>
<p>对于 JavaScript 的这个糟粕，让人来适应机器的问题而修改代码，甚至改变本性习惯，和另一个使用逗号连续定义变量的话题是何其的相似。</p>
<p>为什么不让机器来适应人，在编辑器中编辑、或在编译器中编译 JavaScript 代码时，发现块级作用域之外有使用块级作用域内部定义的变量时，给予恰当的警告。这是否更合理呢。</p>
<p>如果遵循权威的教诲，把变量定义在函数前面，编辑器和编译器都没有办法帮我们了。</p>
<p>我认为：</p>
<ol>
<li><p>定义在块级作用域之内的变量不应该被块级作用域之外使用。</p>
</li>
<li><p>如果被块级作用域之外使用了：</p>
<ol>
<li>要么这是一个错误的用法，会带来隐患。人、编辑器、编译器、甚至将来的解释器可以发现这个问题并给出警告。</li>
<li>或者确实有这样的使用需求，那么这个变量应该被声明在块级作用域之外。</li>
</ol>
</li>
</ol>
<p>所以我比较认同 <strong>就近原则</strong> 这种更合理、更人性的风格。</p>
<ul>
<li><strong>文档、注释应尽可能的靠近代码。</strong></li>
<li><strong>变量声明应尽可能的靠近变量使用。</strong></li>
<li><strong>应尽量限制变量的作用域。</strong></li>
</ul>
<p>文 / 闲耘
原文地址：<a href="http://blog.hotoo.me/post/block-scope-variable-defined.html">http://blog.hotoo.me/post/block-scope-variable-defined.html</a></p>
<hr>
<h3 id="玉伯闲聊">玉伯闲聊</h3><p>就近原则挺有意思，这背后更一般性的原则我觉得是『自然法则』：</p>
<p><strong>写代码要自然，要回归本性。越是新手靠直觉写的代码，往往越是好代码。</strong></p>
<p>比如</p>
<pre><code class="lang-js"><span class="hljs-attribute">var a</span> = 1;
<span class="hljs-attribute">var b</span> = 2;
</code></pre>
<p>比</p>
<pre><code class="lang-js"><span class="hljs-attribute">var a</span> = 1, b = 2;
</code></pre>
<p>更自然。再比如</p>
<pre><code class="lang-js"><span class="hljs-keyword">for</span> (var <span class="hljs-built_in">i</span> = <span class="hljs-number">0</span>; <span class="hljs-built_in">i</span> &lt; arr.<span class="hljs-built_in">length</span>; <span class="hljs-built_in">i</span>++) {
}
</code></pre>
<p>比</p>
<pre><code class="lang-js"><span class="hljs-keyword">for</span> (var <span class="hljs-built_in">i</span> = <span class="hljs-number">0</span>, len = arr.<span class="hljs-built_in">length</span>; <span class="hljs-built_in">i</span> &lt; len; <span class="hljs-built_in">i</span>++) {
}
</code></pre>
<p>更自然。</p>
<p>何谓自然？每个人都有不同理解。上面纯粹只是我觉得更自然、更优。</p>
<p>Code style 有时就像 life style 一样，永远不要贬低其他人的生活方式，但你可以选择与自己内心 style 一致的人一起生活。</p>
<p>最后，你持什么样的观点呢？</p>
<p> 题图：眼睛是窗口，透过它能看见美丽的风景，用心去越过边界。</p>
</div>

    <div class="cat">
    
    <p><span>#</span> <a href="/category/blog/">blog</a></p>
    
    </div>

    <div class="relate">
        
        
        <p><span>PREV: </span><a rel="prev" href="/posts/14222425.html">CSS 学习之我观</a></p>
        

        
        
        <p><span>NEXT: </span><a rel="next" href="/posts/14106074.html">推荐几个微信公众帐号</a></p>
        

        <p><span></span><a rel="all" href="/">VIEW ALL POSTS</a></p>
    </div>

    <div class="comments">
        <div id="disqus_thread"></div>
    </div>

</div>


<div class="footer">
    <div class="center">
        made by AcyOrt / powered by <a target="_blank" href="https://github.com/AcyOrt/acyort">AcyOrt</a> / <a target="_blank" href="/rss.xml">RSS</a>
    </div>
</div>

<script>

var menu = document.querySelector('.menu');

document.querySelector('.main').addEventListener('click', function(e) {
    if (e.target.classList.toString().indexOf('menuicon') > -1) {
        return menu.classList.toggle('active')
    } 

    return menu.classList.remove('active')
})

</script>




<script>
(function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//acyort.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();
</script>



</div>

</body>
</html>
